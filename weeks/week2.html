<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
    <title>SPA 225 — Week 2 (Discussions)</title>
    <meta name="description" content="SPA 225 Discussions — Week 2" />

    <!-- IMPORTANT: referrer policy must be in <head> (not inside body/game) -->
    <meta name="referrer" content="strict-origin-when-cross-origin" />

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap"
      rel="stylesheet"
    />

    <!-- Cache-busting for GitHub Pages -->
    <link rel="stylesheet" href="../style.css?v=3" />
  </head>

  <body>
    <a class="skip-link" href="#main">Skip to content</a>

    <header class="hero" role="banner">
      <div class="hero__inner">
        <h1 class="hero__title">SPA 225: Lying, swearing and breaking the rules</h1>
        <p class="hero__subtitle">Discussions</p>
      </div>
    </header>

    <main id="main" class="main" role="main">
      <nav class="page-nav" aria-label="Week navigation">
        <a class="nav-link" href="../index.html">← Back to weeks</a>

        <div class="nav-group" aria-label="Previous and next week">
          <a class="nav-link" href="./week1.html">← Prev</a>
          <a class="nav-link" href="./week3.html">Next →</a>
        </div>
      </nav>

      <header class="week-header">
        <h2 class="week-title">Week 2</h2>
        <!-- Optional: add dates here later -->
      </header>

      <!-- SLIDES -->
      <section class="card" aria-labelledby="slides-title">
        <h3 id="slides-title" class="section-title">Slides and study material</h3>

        <div class="slides-embed" id="slides-week2" aria-label="Slides and materials container (Week 2)">
          <!-- START EDITABLE: SLIDES/STUDY MATERIAL -->
















<section id="poa-game" aria-label="Flashcards: Puntos de articulación">
  <!--
    ============================================================
    POA FLASHCARDS (Puntos de articulación)
    - CSS scoped under #poa-game
    - JS in an IIFE (no globals)
    ============================================================
  -->

  <div class="poa-shell">
    <header class="poa-header">
      <div class="poa-title-wrap">
        <h3 class="poa-title">Flashcards: Puntos de articulación</h3>
        <p class="poa-subtitle">
          Navega cada tarjeta en 3 pasos. Toca un <strong>sonido</strong> para ver un video corto + ejemplos.
        </p>
      </div>

      <div class="poa-tools" role="group" aria-label="Opciones">
        <button type="button" class="poa-btn poa-btn--ghost" data-action="shuffle" aria-label="Mezclar tarjetas">
          Mezclar
        </button>
        <button
          type="button"
          class="poa-btn poa-btn--ghost"
          data-action="reset"
          aria-label="Reiniciar todas las tarjetas al paso 1"
        >
          Reiniciar
        </button>
      </div>
    </header>

    <div class="poa-grid" data-role="grid" aria-live="polite"></div>
  </div>

  <style>
    /* =========================
       POA GAME — Scoped styles
       ========================= */

    #poa-game {
      --poa-bg: rgba(255, 255, 255, 0.04);
      --poa-border: rgba(255, 255, 255, 0.14);
      --poa-text: rgba(255, 255, 255, 0.92);
      --poa-muted: rgba(255, 255, 255, 0.70);
      --poa-shadow: 0 12px 30px rgba(0, 0, 0, 0.28);

      --poa-accent: rgba(139, 211, 255, 0.95);
      --poa-radius: 16px;
      --poa-radius-sm: 12px;
      --poa-gap: 14px;

      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--poa-text);
    }

    #poa-game .poa-shell {
      border: 1px solid var(--poa-border);
      border-radius: var(--poa-radius);
      background: linear-gradient(180deg, var(--poa-bg), rgba(255, 255, 255, 0.02));
      box-shadow: var(--poa-shadow);
      padding: 16px;
    }

    #poa-game .poa-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    #poa-game .poa-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    #poa-game .poa-subtitle {
      margin: 6px 0 0;
      color: var(--poa-muted);
      font-size: 0.95rem;
      line-height: 1.35;
      max-width: 58ch;
    }

    #poa-game .poa-tools {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    #poa-game .poa-btn {
      appearance: none;
      border: 1px solid var(--poa-border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--poa-text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      user-select: none;
    }

    #poa-game .poa-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.09);
      border-color: rgba(255, 255, 255, 0.22);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
    }

    #poa-game .poa-btn:focus-visible {
      outline: 3px solid rgba(139, 211, 255, 0.75);
      outline-offset: 3px;
    }

    #poa-game .poa-btn--primary {
      border-color: rgba(139, 211, 255, 0.35);
      background: rgba(139, 211, 255, 0.16);
    }

    #poa-game .poa-btn--ghost {
      background: rgba(255, 255, 255, 0.04);
    }

    #poa-game .poa-grid {
      display: grid;
      gap: var(--poa-gap);
      grid-template-columns: 1fr;
      align-items: stretch;
    }

    @media (min-width: 760px) {
      #poa-game .poa-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1120px) {
      #poa-game .poa-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    #poa-game .poa-card {
      border: 1px solid var(--poa-border);
      border-radius: var(--poa-radius);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 360px;
    }

    #poa-game .poa-card__topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.14);
    }

    #poa-game .poa-place {
      display: inline-flex;
      align-items: baseline;
      gap: 10px;
      min-width: 0;
    }

    #poa-game .poa-place__badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      font-weight: 800;
      color: rgba(0, 0, 0, 0.88);
      background: var(--poa-accent);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    #poa-game .poa-place__badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.55);
    }

    #poa-game .poa-place__name {
      font-weight: 800;
      letter-spacing: -0.01em;
      font-size: 1.05rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #poa-game .poa-step {
      font-size: 0.82rem;
      color: var(--poa-muted);
      font-weight: 700;
      white-space: nowrap;
    }

    #poa-game .poa-card__content {
      padding: 14px;
      display: grid;
      gap: 12px;
      flex: 1;
    }

    #poa-game .poa-img {
      width: 100%;
      height: 190px;
      object-fit: contain;
      border-radius: var(--poa-radius-sm);
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.10);
    }

    #poa-game .poa-block {
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--poa-radius-sm);
      padding: 12px;
    }

    #poa-game .poa-block__label {
      margin: 0 0 8px;
      color: var(--poa-muted);
      font-weight: 800;
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    #poa-game .poa-block__text {
      margin: 0;
      font-size: 1.02rem;
      font-weight: 750;
      line-height: 1.35;
    }

    #poa-game .poa-duo {
      display: grid;
      gap: 6px;
    }

    #poa-game .poa-duo .poa-es {
      font-weight: 800;
    }

    #poa-game .poa-duo .poa-en {
      color: var(--poa-muted);
      font-weight: 650;
    }

    #poa-game .poa-chiprow {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #poa-game .poa-chip {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.06);
      color: var(--poa-text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 800;
      letter-spacing: 0.02em;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      user-select: none;
      line-height: 1;
      font-family: "Noto Sans", Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #poa-game .poa-chip:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.10);
      border-color: rgba(255, 255, 255, 0.26);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
    }

    #poa-game .poa-chip:focus-visible {
      outline: 3px solid rgba(184, 242, 209, 0.70);
      outline-offset: 3px;
    }

    #poa-game .poa-card__controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.12);
    }

    #poa-game .poa-mini {
      font-size: 0.86rem;
      color: var(--poa-muted);
      font-weight: 700;
    }

    #poa-game .poa-mini strong {
      color: var(--poa-text);
    }

    #poa-game .poa-video-wrap {
      display: grid;
      gap: 12px;
    }

    #poa-game .poa-video {
      width: 100%;
      border-radius: var(--poa-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.24);
      outline: none;
    }

    #poa-game .poa-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #poa-game .poa-example {
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 0.92rem;
      color: var(--poa-text);
    }

    #poa-game .poa-example span {
      color: var(--poa-muted);
      font-weight: 650;
      margin-left: 6px;
    }

    #poa-game .poa-error {
      border: 1px solid rgba(255, 107, 107, 0.30);
      background: rgba(255, 107, 107, 0.10);
      color: rgba(255, 215, 215, 0.98);
      border-radius: var(--poa-radius-sm);
      padding: 10px 12px;
      font-weight: 700;
    }
  </style>

  <script>
    (() => {
      "use strict";

      const root = document.getElementById("poa-game");
      if (!root) return;

      const grid = root.querySelector('[data-role="grid"]');
      const btnShuffle = root.querySelector('[data-action="shuffle"]');
      const btnReset = root.querySelector('[data-action="reset"]');

      const TOTAL_STEPS = 3;

      // ============================================================
      // START EDITABLE: DATA (Cards + Sounds + Videos + Examples)
      // ============================================================

      const cardsData = [
        {
          id: "bilabial",
          placeEs: "BILABIAL",
          placeEn: "BILABIAL",
          organsEs: "labio inferior + labio superior",
          organsEn: "lower lip + upper lip",
          pointEs: "bilabial",
          pointEn: "bilabial",
          imageSrc: "https://i.imgur.com/eTA4b4f.png",
          imageAlt: "Bilabial place of articulation diagram",
          phonemes: [
            {
              label: "[p]",
              symbol: "p",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/p-sound/examples/sound.mp4",
              examples: [
                { es: "papa", en: "potato" },
                { es: "pato", en: "duck" },
                { es: "sopa", en: "soup" }
              ]
            },
            {
              label: "[b]",
              symbol: "b",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/b-sound/examples/sound.mp4",
              examples: [
                { es: "boca", en: "mouth" },
                { es: "barco", en: "boat/ship" },
                { es: "tambor", en: "drum" }
              ]
            },
            {
              label: "[m]",
              symbol: "m",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/m-sound/examples/sound.mp4",
              examples: [
                { es: "mano", en: "hand" },
                { es: "cama", en: "bed" },
                { es: "mismo", en: "same" }
              ]
            }
          ]
        },
        {
          id: "labiodental",
          placeEs: "LABIODENTAL",
          placeEn: "LABIODENTAL",
          organsEs: "labio inferior + dientes superiores",
          organsEn: "lower lip + upper teeth",
          pointEs: "labiodental",
          pointEn: "labiodental",
          imageSrc: "https://i.imgur.com/R1ICFxW.png",
          imageAlt: "Labiodental place of articulation diagram",
          phonemes: [
            {
              label: "[f]",
              symbol: "f",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/f-sound/examples/sound.mp4",
              examples: [
                { es: "foto", en: "photo" },
                { es: "familia", en: "family" },
                { es: "fuerte", en: "strong" }
              ]
            }
          ]
        },
        {
          id: "dental",
          placeEs: "DENTAL",
          placeEn: "DENTAL",
          organsEs: "punta de la lengua + dientes superiores",
          organsEn: "tongue tip + upper teeth",
          pointEs: "dental",
          pointEn: "dental",
          imageSrc: "https://i.imgur.com/fvXM6Kf.png",
          imageAlt: "Dental place of articulation diagram",
          phonemes: [
            {
              label: "[t̪]",
              symbol: "t",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/t-sound/examples/sound.mp4",
              examples: [
                { es: "taza", en: "cup" },
                { es: "tarde", en: "afternoon" },
                { es: "gato", en: "cat" }
              ]
            },
            {
              label: "[d̪]",
              symbol: "d",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/d-sound/examples/sound.mp4",
              examples: [
                { es: "dedo", en: "finger" },
                { es: "donde", en: "where" },
                { es: "andar", en: "to walk" }
              ]
            },
            {
              label: "[θ]",
              symbol: "θ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/theta-sound/examples/sound.mp4",
              examples: [
                { es: "cena", en: "dinner" },
                { es: "zapato", en: "shoe" },
                { es: "cinco", en: "five" }
              ]
            },
            {
              label: "[ð]",
              symbol: "ð",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/eth-low-sound/examples/sound.mp4",
              examples: [
                { es: "cada", en: "each" },
                { es: "nada", en: "nothing" },
                { es: "lado", en: "side" }
              ]
            }
          ]
        },
        {
          id: "alveolar",
          placeEs: "ALVEOLAR",
          placeEn: "ALVEOLAR",
          organsEs: "punta de la lengua + alvéolos",
          organsEn: "tongue tip + alveolar ridge",
          pointEs: "alveolar",
          pointEn: "alveolar",
          imageSrc: "https://i.imgur.com/0xUzUmC.png",
          imageAlt: "Alveolar place of articulation diagram",
          phonemes: [
            {
              label: "[s]",
              symbol: "s",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/s-sound/examples/sound.mp4",
              examples: [
                { es: "sapo", en: "toad" },
                { es: "casa", en: "house" },
                { es: "dos", en: "two" }
              ]
            },
            {
              label: "[n]",
              symbol: "n",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-bridge-sound/examples/sound.mp4",
              examples: [
                { es: "nube", en: "cloud" },
                { es: "pan", en: "bread" },
                { es: "nada", en: "nothing" }
              ]
            },
            {
              label: "[ɾ]",
              symbol: "ɾ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-short-sound/examples/sound.mp4",
              examples: [
                { es: "pero", en: "but" },
                { es: "cara", en: "face" },
                { es: "arena", en: "sand" }
              ]
            },
            {
              label: "[r]",
              symbol: "r",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-rolled-sound/examples/sound.mp4",
              examples: [
                { es: "perro", en: "dog" },
                { es: "carro", en: "car/cart" },
                { es: "rojo", en: "red" }
              ]
            },
            {
              label: "[l]",
              symbol: "l",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/l-hiarch-sound/examples/sound.mp4",
              examples: [
                { es: "luna", en: "moon" },
                { es: "pelo", en: "hair" },
                { es: "sal", en: "salt" }
              ]
            }
          ]
        },
        {
          id: "posalveolar",
          placeEs: "POSALVEOLAR",
          placeEn: "POSALVEOLAR",
          organsEs: "lámina de la lengua + zona justo detrás de los alvéolos",
          organsEn: "tongue blade + area just behind the alveolar ridge",
          pointEs: "posalveolar",
          pointEn: "posalveolar",
          imageSrc: "https://i.imgur.com/vD0C2wx.png",
          imageAlt: "Posalveolar place of articulation diagram",
          phonemes: [
            {
              label: "[ʧ]",
              symbol: "ʧ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/ch-sound/examples/sound.mp4",
              examples: [
                { es: "chico", en: "boy" },
                { es: "leche", en: "milk" },
                { es: "mucho", en: "a lot" }
              ]
            }
          ]
        },
        {
          id: "palatal",
          placeEs: "PALATAL",
          placeEn: "PALATAL",
          organsEs: "dorso medio de la lengua + paladar",
          organsEn: "mid tongue dorsum + hard palate",
          pointEs: "palatal",
          pointEn: "palatal",
          imageSrc: "https://i.imgur.com/yAriL9U.png",
          imageAlt: "Palatal place of articulation diagram",
          phonemes: [
            {
              label: "[ɲ]",
              symbol: "ɲ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-left-sound/examples/sound.mp4",
              examples: [
                { es: "niño", en: "child" },
                { es: "mañana", en: "tomorrow" },
                { es: "señor", en: "sir" }
              ]
            },
            {
              label: "[ʝ]",
              symbol: "ʝ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/yot-sound/examples/sound.mp4",
              examples: [
                { es: "yo", en: "I" },
                { es: "ayer", en: "yesterday" },
                { es: "mayo", en: "May" }
              ]
            }
          ]
        },
        {
          id: "velar",
          placeEs: "VELAR",
          placeEn: "VELAR",
          organsEs: "dorso posterior de la lengua + velo",
          organsEn: "back tongue dorsum + velum",
          pointEs: "velar",
          pointEn: "velar",
          imageSrc: "https://i.imgur.com/5qqyMDZ.png",
          imageAlt: "Velar place of articulation diagram",
          phonemes: [
            {
              label: "[k]",
              symbol: "k",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/k-sound/examples/sound.mp4",
              examples: [
                { es: "casa", en: "house" },
                { es: "queso", en: "cheese" },
                { es: "kilo", en: "kilogram" }
              ]
            },
            {
              label: "[g]",
              symbol: "g",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/g-sound/examples/sound.mp4",
              examples: [
                { es: "gato", en: "cat" },
                { es: "guerra", en: "war" },
                { es: "amigo", en: "friend" }
              ]
            },
            {
              label: "[ŋ]",
              symbol: "ŋ",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-right1-sound/examples/sound.mp4",
              examples: [
                { es: "tengo", en: "I have" },
                { es: "banco", en: "bank" },
                { es: "cinco", en: "five" }
              ]
            },
            {
              label: "[x]",
              symbol: "x",
              videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/chi-sound/examples/sound.mp4",
              examples: [
                { es: "jamón", en: "ham" },
                { es: "gente", en: "people" },
                { es: "ojo", en: "eye" }
              ]
            }
          ]
        }
      ];

      // ============================================================
      // END EDITABLE: DATA
      // ============================================================

      const state = new Map(); // cardId -> { step, mode, phonemeIndex, error }

      function initState(data) {
        state.clear();
        data.forEach((c) => state.set(c.id, { step: 1, mode: "steps", phonemeIndex: null, error: false }));
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function setCardState(cardId, patch) {
        const current = state.get(cardId);
        if (!current) return;
        state.set(cardId, { ...current, ...patch });
      }

      function renderAll(data) {
        if (!grid) return;
        grid.innerHTML = data
          .map((card) => {
            const st = state.get(card.id) || { step: 1, mode: "steps", phonemeIndex: null, error: false };
            return renderCard(card, st);
          })
          .join("");
      }

      function renderCard(card, st) {
        const step = clamp(st.step, 1, TOTAL_STEPS);
        const isVideo = st.mode === "video" && Number.isInteger(st.phonemeIndex);
        const stepLabel = `Paso ${step}/${TOTAL_STEPS}`;

        return `
          <article class="poa-card" data-card-id="${escapeHtml(card.id)}">
            <div class="poa-card__topbar">
              <div class="poa-place">
                <span class="poa-place__badge" aria-hidden="true"></span>
                <span class="poa-place__name">${escapeHtml(card.placeEs)}</span>
              </div>
              <div class="poa-step" aria-label="Indicador de paso">${escapeHtml(stepLabel)}</div>
            </div>

            <div class="poa-card__content">
              ${isVideo ? renderVideoMode(card, st) : renderStepMode(card, step)}
            </div>

            <div class="poa-card__controls">
              <button type="button"
                class="poa-btn poa-btn--primary"
                data-action="back"
                ${isVideo ? "" : step === 1 ? 'aria-disabled="true"' : ""}
                ${isVideo ? "" : step === 1 ? "disabled" : ""}
              >
                ← Atrás
              </button>

              <div class="poa-mini" aria-label="Paso actual">
                <strong>${escapeHtml(stepLabel)}</strong>
              </div>

              <button type="button"
                class="poa-btn poa-btn--primary"
                data-action="next"
                ${isVideo ? 'aria-disabled="true"' : step === TOTAL_STEPS ? 'aria-disabled="true"' : ""}
                ${isVideo ? "disabled" : step === TOTAL_STEPS ? "disabled" : ""}
              >
                Siguiente →
              </button>
            </div>
          </article>
        `;
      }

      function renderStepMode(card, step) {
        if (step === 1) {
          return `
            <img class="poa-img" src="${escapeHtml(card.imageSrc)}" alt="${escapeHtml(card.imageAlt)}" loading="lazy" />
            <div class="poa-block">
              <p class="poa-block__label">Representación</p>
              <p class="poa-block__text">${escapeHtml(card.placeEs)}</p>
            </div>
          `;
        }

        if (step === 2) {
          return `
            <img class="poa-img" src="${escapeHtml(card.imageSrc)}" alt="${escapeHtml(card.imageAlt)}" loading="lazy" />
            <div class="poa-block">
              <p class="poa-block__label">Órganos</p>
              <div class="poa-duo">
                <div class="poa-es">${escapeHtml(card.organsEs)}</div>
                <div class="poa-en">${escapeHtml(card.organsEn)}</div>
              </div>
            </div>
          `;
        }

        const chips = (card.phonemes || [])
          .map(
            (p, idx) => `
              <button type="button" class="poa-chip" data-action="open-phoneme" data-phoneme-index="${idx}">
                ${escapeHtml(p.label)}
              </button>
            `
          )
          .join("");

        return `
          <img class="poa-img" src="${escapeHtml(card.imageSrc)}" alt="${escapeHtml(card.imageAlt)}" loading="lazy" />
          <div class="poa-block">
            <p class="poa-block__label">Sonidos</p>
            <div class="poa-chiprow" role="list">
              ${chips || `<span class="poa-mini">No hay sonidos.</span>`}
            </div>
          </div>
        `;
      }

      function renderVideoMode(card, st) {
        const idx = st.phonemeIndex;
        const phoneme = (card.phonemes || [])[idx];
        if (!phoneme) {
          return `
            <div class="poa-error">No se encontró el sonido seleccionado.</div>
            <button type="button" class="poa-btn poa-btn--ghost" data-action="back-to-phonemes">← Volver a sonidos</button>
          `;
        }

        const examples = (phoneme.examples || [])
          .map((ex) => `<span class="poa-example">${escapeHtml(ex.es)} <span>(${escapeHtml(ex.en)})</span></span>`)
          .join("");

        const errorBox = st.error
          ? `<div class="poa-error">No se pudo cargar el video. Intenta recargar.</div>`
          : "";

        return `
          <div class="poa-video-wrap">
            ${errorBox}

            <video class="poa-video" controls preload="metadata" data-role="video" src="${escapeHtml(phoneme.videoUrl)}">
              Tu navegador no soporta video.
            </video>

            <div class="poa-block">
              <p class="poa-block__label">Ejemplos</p>
              <div class="poa-examples">
                ${examples || `<span class="poa-mini">No hay ejemplos.</span>`}
              </div>
            </div>

            <button type="button" class="poa-btn poa-btn--ghost" data-action="back-to-phonemes">
              ← Volver a sonidos
            </button>
          </div>
        `;
      }

      function handleGridClick(e) {
        const btn = e.target.closest("button");
        if (!btn) return;

        const cardEl = btn.closest("[data-card-id]");
        if (!cardEl) return;

        const cardId = cardEl.getAttribute("data-card-id");
        const card = cardsData.find((c) => c.id === cardId);
        if (!card) return;

        const action = btn.getAttribute("data-action");
        const st = state.get(cardId);
        if (!st) return;

        if (action === "back") {
          if (st.mode === "video") return;
          setCardState(cardId, { step: clamp(st.step - 1, 1, TOTAL_STEPS), error: false });
          renderAll(cardsData);
          return;
        }

        if (action === "next") {
          if (st.mode === "video") return;
          setCardState(cardId, { step: clamp(st.step + 1, 1, TOTAL_STEPS), error: false });
          renderAll(cardsData);
          return;
        }

        if (action === "open-phoneme") {
          if (st.step !== TOTAL_STEPS) return;

          const idxStr = btn.getAttribute("data-phoneme-index");
          const idx = Number(idxStr);
          if (!Number.isInteger(idx)) return;

          setCardState(cardId, { mode: "video", phonemeIndex: idx, error: false });
          renderAll(cardsData);

          const updatedCard = grid.querySelector(`[data-card-id="${CSS.escape(cardId)}"]`);
          const video = updatedCard?.querySelector('[data-role="video"]');
          if (video) video.focus?.();
          return;
        }

        if (action === "back-to-phonemes") {
          setCardState(cardId, { mode: "steps", phonemeIndex: null, error: false, step: TOTAL_STEPS });
          renderAll(cardsData);
          return;
        }
      }

      function handleVideoError(e) {
        const video = e.target.closest("video");
        if (!video) return;

        const cardEl = video.closest("[data-card-id]");
        if (!cardEl) return;

        const cardId = cardEl.getAttribute("data-card-id");
        const st = state.get(cardId);
        if (!st) return;

        setCardState(cardId, { error: true });
        renderAll(cardsData);
      }

      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      function onShuffle() {
        shuffleInPlace(cardsData);
        initState(cardsData);
        renderAll(cardsData);
      }

      function onReset() {
        initState(cardsData);
        renderAll(cardsData);
      }

      grid.addEventListener("click", handleGridClick);
      grid.addEventListener("error", handleVideoError, true);

      btnShuffle?.addEventListener("click", onShuffle);
      btnReset?.addEventListener("click", onReset);

      initState(cardsData);
      renderAll(cardsData);
    })();
  </script>
</section>

<section id="moa-game" aria-label="Flashcards: Modos de articulación">
  <!--
    ============================================================
    MOA FLASHCARDS (Modos de articulación)
    - CSS scoped under #moa-game
    - JS fully encapsulated in an IIFE (no globals)
    - 3 steps + sound video mode
    - Step 1: ONLY youtube.com embed (no buttons/links)
    ============================================================
  -->

  <div class="moa-shell">
    <header class="moa-header">
      <div class="moa-title-wrap">
        <h3 class="moa-title">Flashcards: Modos de articulación</h3>
        <p class="moa-subtitle">
          Navega cada tarjeta en 3 pasos: Paso 1: video del modo; Paso 2: explicación; Paso 3: sonidos. Toca un
          <strong>sonido</strong> para ver un video corto + ejemplos + el punto de articulación.
        </p>
      </div>

      <div class="moa-tools" role="group" aria-label="Opciones">
        <button type="button" class="moa-btn moa-btn--ghost" data-action="shuffle" aria-label="Mezclar tarjetas">
          Mezclar
        </button>
        <button
          type="button"
          class="moa-btn moa-btn--ghost"
          data-action="reset"
          aria-label="Reiniciar todas las tarjetas al paso 1"
        >
          Reiniciar
        </button>
      </div>
    </header>

    <div class="moa-grid" data-role="grid" aria-live="polite"></div>
  </div>

  <style>
    /* =========================
       MOA GAME — Scoped styles
       ========================= */

    #moa-game {
      --moa-bg: rgba(255, 255, 255, 0.04);
      --moa-bg2: rgba(255, 255, 255, 0.06);
      --moa-border: rgba(255, 255, 255, 0.14);
      --moa-text: rgba(255, 255, 255, 0.92);
      --moa-muted: rgba(255, 255, 255, 0.70);
      --moa-shadow: 0 12px 30px rgba(0, 0, 0, 0.28);

      --moa-accent: rgba(139, 211, 255, 0.95);
      --moa-accent2: rgba(184, 242, 209, 0.92);
      --moa-danger: rgba(255, 107, 107, 0.92);

      --moa-radius: 16px;
      --moa-radius-sm: 12px;
      --moa-gap: 14px;

      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--moa-text);
    }

    #moa-game .moa-shell {
      border: 1px solid var(--moa-border);
      border-radius: var(--moa-radius);
      background: linear-gradient(180deg, var(--moa-bg), rgba(255, 255, 255, 0.02));
      box-shadow: var(--moa-shadow);
      padding: 16px;
    }

    #moa-game .moa-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 14px;
      margin-bottom: 14px;
    }

    #moa-game .moa-title {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 800;
      letter-spacing: -0.01em;
    }

    #moa-game .moa-subtitle {
      margin: 6px 0 0;
      color: var(--moa-muted);
      font-size: 0.95rem;
      line-height: 1.35;
      max-width: 70ch;
    }

    #moa-game .moa-tools {
      display: inline-flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    #moa-game .moa-btn {
      appearance: none;
      border: 1px solid var(--moa-border);
      background: rgba(255, 255, 255, 0.06);
      color: var(--moa-text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.01em;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      user-select: none;
    }

    #moa-game .moa-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.09);
      border-color: rgba(255, 255, 255, 0.22);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
    }

    #moa-game .moa-btn:focus-visible {
      outline: 3px solid rgba(139, 211, 255, 0.75);
      outline-offset: 3px;
    }

    #moa-game .moa-btn--primary {
      border-color: rgba(139, 211, 255, 0.35);
      background: rgba(139, 211, 255, 0.16);
    }

    #moa-game .moa-btn--ghost {
      background: rgba(255, 255, 255, 0.04);
    }

    #moa-game .moa-grid {
      display: grid;
      gap: var(--moa-gap);
      grid-template-columns: 1fr;
      align-items: stretch;
    }

    @media (min-width: 760px) {
      #moa-game .moa-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    @media (min-width: 1120px) {
      #moa-game .moa-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    #moa-game .moa-card {
      border: 1px solid var(--moa-border);
      border-radius: var(--moa-radius);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.03));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      min-height: 390px;
    }

    #moa-game .moa-card__topbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.14);
    }

    #moa-game .moa-mode {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      min-width: 0;
      flex: 1;
    }

    #moa-game .moa-mode__badge {
      flex: 0 0 auto;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      font-weight: 800;
      color: rgba(0, 0, 0, 0.88);
      background: var(--moa-accent);
      padding: 6px 10px;
      border-radius: 999px;
      white-space: nowrap;
    }

    #moa-game .moa-mode__badge::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.55);
    }

    #moa-game .moa-mode__names {
      min-width: 0;
      flex: 1;
      display: grid;
      gap: 2px;
      line-height: 1.15;
    }

    #moa-game .moa-mode__name-es {
      font-weight: 900;
      letter-spacing: -0.01em;
      font-size: 1.02rem;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    #moa-game .moa-mode__name-en {
      font-weight: 700;
      color: var(--moa-muted);
      font-size: 0.92rem;
      white-space: normal;
      overflow-wrap: anywhere;
    }

    #moa-game .moa-step {
      flex: 0 0 auto;
      font-size: 0.82rem;
      color: var(--moa-muted);
      font-weight: 800;
      white-space: nowrap;
      padding-left: 8px;
    }

    #moa-game .moa-card__content {
      padding: 14px;
      display: grid;
      gap: 12px;
      flex: 1;
    }

    #moa-game .moa-block {
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(255, 255, 255, 0.04);
      border-radius: var(--moa-radius-sm);
      padding: 12px;
    }

    #moa-game .moa-block__label {
      margin: 0 0 8px;
      color: var(--moa-muted);
      font-weight: 900;
      font-size: 0.82rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
    }

    #moa-game .moa-block__text {
      margin: 0;
      font-size: 1.02rem;
      font-weight: 750;
      line-height: 1.35;
    }

    #moa-game .moa-duo {
      display: grid;
      gap: 6px;
    }

    #moa-game .moa-duo .moa-es {
      font-weight: 850;
    }

    #moa-game .moa-duo .moa-en {
      color: var(--moa-muted);
      font-weight: 650;
    }

    #moa-game .moa-card__controls {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px 14px;
      border-top: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(0, 0, 0, 0.12);
    }

    #moa-game .moa-mini {
      font-size: 0.86rem;
      color: var(--moa-muted);
      font-weight: 800;
      white-space: nowrap;
    }

    #moa-game .moa-mini strong {
      color: var(--moa-text);
    }

    #moa-game .moa-chiprow {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #moa-game .moa-chip {
      appearance: none;
      border: 1px solid rgba(255, 255, 255, 0.16);
      background: rgba(255, 255, 255, 0.06);
      color: var(--moa-text);
      padding: 10px 12px;
      border-radius: 999px;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.02em;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease, box-shadow 160ms ease;
      user-select: none;
      line-height: 1;
      font-family: "Noto Sans", Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #moa-game .moa-chip:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.10);
      border-color: rgba(255, 255, 255, 0.26);
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.25);
    }

    #moa-game .moa-chip:focus-visible {
      outline: 3px solid rgba(184, 242, 209, 0.70);
      outline-offset: 3px;
    }

    #moa-game .moa-yt {
      position: relative;
      border-radius: var(--moa-radius-sm);
      overflow: hidden;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.24);
      min-height: 210px;
      display: grid;
      place-items: center;
    }

    #moa-game .moa-yt iframe {
      width: 100%;
      height: 240px;
      border: 0;
      display: block;
      background: rgba(0, 0, 0, 0.25);
    }

    #moa-game .moa-video-wrap {
      display: grid;
      gap: 12px;
    }

    #moa-game .moa-video {
      width: 100%;
      border-radius: var(--moa-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: rgba(0, 0, 0, 0.24);
      outline: none;
    }

    #moa-game .moa-placeimg {
      width: 100%;
      height: 180px;
      object-fit: contain;
      border-radius: var(--moa-radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.10);
      background: rgba(255, 255, 255, 0.04);
    }

    #moa-game .moa-examples {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    #moa-game .moa-example {
      border: 1px solid rgba(255, 255, 255, 0.14);
      background: rgba(255, 255, 255, 0.05);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 0.92rem;
      color: var(--moa-text);
    }

    #moa-game .moa-example span {
      color: var(--moa-muted);
      font-weight: 650;
      margin-left: 6px;
    }

    #moa-game .moa-error {
      border: 1px solid rgba(255, 107, 107, 0.30);
      background: rgba(255, 107, 107, 0.10);
      color: rgba(255, 215, 215, 0.98);
      border-radius: var(--moa-radius-sm);
      padding: 10px 12px;
      font-weight: 800;
    }
  </style>

  <script>
    (() => {
      "use strict";

      const root = document.getElementById("moa-game");
      if (!root) return;

      const grid = root.querySelector('[data-role="grid"]');
      const btnShuffle = root.querySelector('[data-action="shuffle"]');
      const btnReset = root.querySelector('[data-action="reset"]');

      const TOTAL_STEPS = 3;

      // ============================================================
      // START EDITABLE: TRANSLATIONS (Mode names + Step 2 EN texts)
      // ============================================================
      const modeNameEn = {
        "Oclusiva": "Stop/Plosive",
        "Fricativa": "Fricative",
        "Africada": "Affricate",
        "Nasal": "Nasal",
        "Lateral": "Lateral",
        "Vibrante simple": "Tap/Flap",
        "Vibrante múltiple": "Trill"
      };

      const airflowEn = {
        "Oclusiva":
          "Air is fully blocked for a moment by a complete closure in the oral cavity, and then it is released.",
        "Fricativa":
          "Air passes through a small obstruction (a narrowing) in the oral cavity, which creates friction.",
        "Africada":
          "A combination of stop + fricative: first there is a complete closure (like a stop), and then air passes through a narrowing with friction (like a fricative).",
        "Nasal":
          "There is a complete closure in the oral cavity, but the velum (soft palate) lowers and air exits through the nasal cavity.",
        "Lateral":
          "There is a closure in the center (the tongue touches above), and air flows out along the sides of the tongue.",
        "Vibrante simple":
          "Air exits through the mouth and flows over the tongue (mainly through the center, though it can escape at the sides); the tongue tip makes one brief contact (a tap) against the alveolar ridge.",
        "Vibrante múltiple":
          "Air exits through the mouth and flows over the tongue (mainly through the center, though it can escape at the sides); the tongue tip makes several rapid contacts (a trill) against the alveolar ridge."
      };
      // ============================================================
      // END EDITABLE: TRANSLATIONS
      // ============================================================

      // ============================================================
      // START EDITABLE: PHONEME LIBRARY (mp4 + place image + examples)
      // Notes:
      // - [t̪] uses key "t"
      // - [d̪] uses key "d"
      // - label [ʧ] uses key "ʧ"
      // ============================================================
      const phonemeLibrary = {
        "p": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/p-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          examples: [
            { es: "papa", en: "potato" },
            { es: "pato", en: "duck" },
            { es: "sopa", en: "soup" }
          ]
        },
        "b": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/b-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          examples: [
            { es: "boca", en: "mouth" },
            { es: "barco", en: "boat/ship" },
            { es: "tambor", en: "drum" }
          ]
        },
        "m": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/m-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          examples: [
            { es: "mano", en: "hand" },
            { es: "cama", en: "bed" },
            { es: "mismo", en: "same" }
          ]
        },
        "f": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/f-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/R1ICFxW.png",
          examples: [
            { es: "foto", en: "photo" },
            { es: "familia", en: "family" },
            { es: "fuerte", en: "strong" }
          ]
        },
        "t": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/t-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          examples: [
            { es: "taza", en: "cup" },
            { es: "tarde", en: "afternoon" },
            { es: "gato", en: "cat" }
          ]
        },
        "d": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/d-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          examples: [
            { es: "dedo", en: "finger" },
            { es: "donde", en: "where" },
            { es: "andar", en: "to walk" }
          ]
        },
        "θ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/theta-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          examples: [
            { es: "cena", en: "dinner" },
            { es: "zapato", en: "shoe" },
            { es: "cinco", en: "five" }
          ]
        },
        "ð": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/eth-low-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          examples: [
            { es: "cada", en: "each" },
            { es: "nada", en: "nothing" },
            { es: "lado", en: "side" }
          ]
        },
        "s": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/s-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          examples: [
            { es: "sapo", en: "toad" },
            { es: "casa", en: "house" },
            { es: "dos", en: "two" }
          ]
        },
        "n": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-bridge-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          examples: [
            { es: "nube", en: "cloud" },
            { es: "pan", en: "bread" },
            { es: "nada", en: "nothing" }
          ]
        },
        "ɾ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-short-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          examples: [
            { es: "pero", en: "but" },
            { es: "cara", en: "face" },
            { es: "arena", en: "sand" }
          ]
        },
        "r": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-rolled-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          examples: [
            { es: "perro", en: "dog" },
            { es: "carro", en: "car/cart" },
            { es: "rojo", en: "red" }
          ]
        },
        "l": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/l-hiarch-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          examples: [
            { es: "luna", en: "moon" },
            { es: "pelo", en: "hair" },
            { es: "sal", en: "salt" }
          ]
        },
        "ɲ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-left-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/yAriL9U.png",
          examples: [
            { es: "niño", en: "child" },
            { es: "mañana", en: "tomorrow" },
            { es: "señor", en: "sir" }
          ]
        },
        "k": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/k-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          examples: [
            { es: "casa", en: "house" },
            { es: "queso", en: "cheese" },
            { es: "kilo", en: "kilogram" }
          ]
        },
        "g": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/g-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          examples: [
            { es: "gato", en: "cat" },
            { es: "guerra", en: "war" },
            { es: "amigo", en: "friend" }
          ]
        },
        "ŋ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-right1-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          examples: [
            { es: "tengo", en: "I have" },
            { es: "banco", en: "bank" },
            { es: "cinco", en: "five" }
          ]
        },
        "x": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/chi-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          examples: [
            { es: "jamón", en: "ham" },
            { es: "gente", en: "people" },
            { es: "ojo", en: "eye" }
          ]
        },
        "ʝ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/yot-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/yAriL9U.png",
          examples: [
            { es: "yo", en: "I" },
            { es: "ayer", en: "yesterday" },
            { es: "mayo", en: "May" }
          ]
        },
        "ʧ": {
          videoUrl: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/ch-sound/examples/sound.mp4",
          placeImageUrl: "https://i.imgur.com/vD0C2wx.png",
          examples: [
            { es: "chico", en: "boy" },
            { es: "leche", en: "milk" },
            { es: "mucho", en: "a lot" }
          ]
        }
      };
      // ============================================================
      // END EDITABLE: PHONEME LIBRARY
      // ============================================================

      // ============================================================
      // START EDITABLE: MODES (cardsData) — order matters (keep exact)
      // ============================================================
      const cardsData = [
        {
          id: "oclusiva",
          modeEs: "Oclusiva",
          descEs: "cuando el aire queda bloqueado un instante por un cierre total en la cavidad bucal y luego se suelta.",
          youtubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg",
          phonemes: ["[p]", "[b]", "[t̪]", "[d̪]", "[k]", "[g]"]
        },
        {
          id: "fricativa",
          modeEs: "Fricativa",
          descEs:
            "cuando el aire pasa por una obstrucción pequeña (estrechamiento) en la cavidad bucal y eso produce fricción.",
          youtubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY",
          phonemes: ["[f]", "[θ]", "[ð]", "[s]", "[ʝ]", "[x]"]
        },
        {
          id: "africada",
          modeEs: "Africada",
          descEs:
            "combinación de oclusiva + fricativa: primero hay cierre total (como oclusiva) y luego el aire pasa por un estrechamiento con fricción (como fricativa).",
          youtubeUrl: "https://www.youtube.com/watch?v=iCkWykHg394",
          phonemes: ["[ʧ]"]
        },
        {
          id: "nasal",
          modeEs: "Nasal",
          descEs:
            "hay un cierre total en la cavidad bucal, pero el velo (paladar blando) baja y el aire sale por la cavidad nasal.",
          youtubeUrl: "https://youtu.be/QU4l_fwGDpU",
          phonemes: ["[m]", "[n]", "[ɲ]", "[ŋ]"]
        },
        {
          id: "lateral",
          modeEs: "Lateral",
          descEs: "hay un cierre en el centro (la lengua toca arriba), y el aire sale por los lados de la lengua.",
          youtubeUrl: "https://youtu.be/8Piih6Wang4",
          phonemes: ["[l]"]
        },
        {
          id: "tap",
          modeEs: "Vibrante simple",
          descEs:
            "el aire sale por la boca y pasa por arriba de la lengua (principalmente por el centro, puede escapar por los lados); la punta de la lengua hace 1 contacto breve (“golpe”) con los alvéolos.",
          youtubeUrl: "https://youtu.be/8Piih6Wang4",
          phonemes: ["[ɾ]"]
        },
        {
          id: "trill",
          modeEs: "Vibrante múltiple",
          descEs:
            "el aire sale por la boca y pasa por arriba de la lengua (principalmente por el centro, puede escapar por los lados); la punta de la lengua hace varios contactos rápidos (“trino”) con los alvéolos.",
          youtubeUrl: "https://youtu.be/8Piih6Wang4",
          phonemes: ["[r]"]
        }
      ];
      // ============================================================
      // END EDITABLE: MODES
      // ============================================================

      const state = new Map(); // cardId -> { step, mode, phonemeLabel, error }

      function initState(data) {
        state.clear();
        data.forEach((c) =>
          state.set(c.id, {
            step: 1,
            mode: "steps",
            phonemeLabel: null,
            error: false
          })
        );
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function clamp(n, a, b) {
        return Math.max(a, Math.min(b, n));
      }

      function setCardState(cardId, patch) {
        const current = state.get(cardId);
        if (!current) return;
        state.set(cardId, { ...current, ...patch });
      }

      function sanitizeUrl(raw) {
        return String(raw || "")
          .trim()
          .replace(/[)\].,;:]+$/g, "");
      }

      function parseYouTubeId(url) {
        try {
          const cleaned = sanitizeUrl(url);
          const u = new URL(cleaned);
          if (u.hostname.includes("youtu.be")) {
            const parts = u.pathname.split("/").filter(Boolean);
            return parts[0] || null;
          }
          if (u.hostname.includes("youtube.com")) return u.searchParams.get("v");
        } catch (_) {}
        return null;
      }

      function buildYouTubeEmbedSrc(videoId) {
        const origin = window.location && window.location.origin ? window.location.origin : "";
        const params = new URLSearchParams({
          rel: "0",
          modestbranding: "1",
          playsinline: "1"
        });

        if (origin && origin !== "null") params.set("origin", origin);

        return `https://www.youtube.com/embed/${encodeURIComponent(videoId)}?${params.toString()}`;
      }

      function phonemeKeyFromLabel(label) {
        const raw = String(label).trim().replace(/^\[/, "").replace(/\]$/, "");
        if (raw === "t̪") return "t";
        if (raw === "d̪") return "d";
        return raw;
      }

      function renderAll(data) {
        if (!grid) return;
        grid.innerHTML = data
          .map((card) => {
            const st =
              state.get(card.id) || {
                step: 1,
                mode: "steps",
                phonemeLabel: null,
                error: false
              };
            return renderCard(card, st);
          })
          .join("");
      }

      function renderCard(card, st) {
        const step = clamp(st.step, 1, TOTAL_STEPS);
        const isSoundVideo = st.mode === "phonemeVideo" && !!st.phonemeLabel;
        const stepLabel = `Paso ${step}/${TOTAL_STEPS}`;

        const en = modeNameEn[card.modeEs] || "";

        return `
          <article class="moa-card" data-card-id="${escapeHtml(card.id)}">
            <div class="moa-card__topbar">
              <div class="moa-mode">
                <span class="moa-mode__badge" aria-hidden="true"></span>
                <div class="moa-mode__names">
                  <div class="moa-mode__name-es">${escapeHtml(card.modeEs)}</div>
                  <div class="moa-mode__name-en">${escapeHtml(en)}</div>
                </div>
              </div>
              <div class="moa-step" aria-label="Indicador de paso">${escapeHtml(stepLabel)}</div>
            </div>

            <div class="moa-card__content">
              ${isSoundVideo ? renderPhonemeVideoMode(card, st) : renderStepMode(card, step, st)}
            </div>

            <div class="moa-card__controls">
              <button type="button"
                class="moa-btn moa-btn--primary"
                data-action="back"
                ${isSoundVideo ? "" : step === 1 ? 'aria-disabled="true"' : ""}
                ${isSoundVideo ? "" : step === 1 ? "disabled" : ""}
              >
                ← Atrás
              </button>

              <div class="moa-mini" aria-label="Paso actual">
                <strong>${escapeHtml(stepLabel)}</strong>
              </div>

              <button type="button"
                class="moa-btn moa-btn--primary"
                data-action="next"
                ${isSoundVideo ? 'aria-disabled="true"' : step === TOTAL_STEPS ? 'aria-disabled="true"' : ""}
                ${isSoundVideo ? "disabled" : step === TOTAL_STEPS ? "disabled" : ""}
              >
                Siguiente →
              </button>
            </div>
          </article>
        `;
      }

      function renderStepMode(card, step, st) {
        if (step === 1) {
          const id = parseYouTubeId(card.youtubeUrl);

          if (!id) {
            return `
              <div class="moa-error">No se pudo leer el link de YouTube.</div>
              <div class="moa-block">
                <p class="moa-block__label">Video del modo</p>
                <p class="moa-block__text">${escapeHtml(card.youtubeUrl)}</p>
              </div>
            `;
          }

          const src = buildYouTubeEmbedSrc(id);

          return `
            <div class="moa-block">
              <p class="moa-block__label">Video del modo</p>

              <div class="moa-yt" data-role="yt">
                <iframe
                  title="Video del modo: ${escapeHtml(card.modeEs)}"
                  src="${escapeHtml(src)}"
                  referrerpolicy="strict-origin-when-cross-origin"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen
                  loading="lazy"
                ></iframe>
              </div>
            </div>
          `;
        }

        if (step === 2) {
          const en = airflowEn[card.modeEs] || "";
          return `
            <div class="moa-block">
              <p class="moa-block__label">Explicación</p>
              <div class="moa-duo">
                <div class="moa-es">${escapeHtml(card.descEs)}</div>
                <div class="moa-en">${escapeHtml(en)}</div>
              </div>
            </div>
          `;
        }

        const chips = (card.phonemes || [])
          .map(
            (lab) => `
              <button type="button" class="moa-chip" data-action="open-phoneme" data-phoneme-label="${escapeHtml(lab)}">
                ${escapeHtml(lab)}
              </button>
            `
          )
          .join("");

        return `
          <div class="moa-block">
            <p class="moa-block__label">Sonidos</p>
            <div class="moa-chiprow" role="list">
              ${chips || `<span class="moa-mini">No hay sonidos.</span>`}
            </div>
          </div>
        `;
      }

      function renderPhonemeVideoMode(card, st) {
        const label = st.phonemeLabel;
        const key = phonemeKeyFromLabel(label);
        const info = phonemeLibrary[key];

        if (!info) {
          return `
            <div class="moa-error">No se encontró data para el sonido ${escapeHtml(label)}.</div>
            <button type="button" class="moa-btn moa-btn--ghost" data-action="back-to-phonemes">← Volver a sonidos</button>
          `;
        }

        const examples = (info.examples || [])
          .map((ex) => `<span class="moa-example">${escapeHtml(ex.es)} <span>(${escapeHtml(ex.en)})</span></span>`)
          .join("");

        const errorBox = st.error
          ? `<div class="moa-error">No se pudo cargar el video. Intenta recargar.</div>`
          : "";

        return `
          <div class="moa-video-wrap">
            <div class="moa-block">
              <p class="moa-block__label">Modo + sonido</p>
              <p class="moa-block__text">${escapeHtml(card.modeEs)} · ${escapeHtml(label)}</p>
            </div>

            ${errorBox}

            <video class="moa-video" controls preload="metadata" playsinline data-role="phoneme-video" src="${escapeHtml(info.videoUrl)}">
              Tu navegador no soporta video.
            </video>

            <div class="moa-block">
              <p class="moa-block__label">Punto de articulación</p>
              <img class="moa-placeimg" src="${escapeHtml(info.placeImageUrl)}" alt="Imagen del punto de articulación para ${escapeHtml(label)}" loading="lazy" />
            </div>

            <div class="moa-block">
              <p class="moa-block__label">Ejemplos</p>
              <div class="moa-examples">
                ${examples || `<span class="moa-mini">No hay ejemplos.</span>`}
              </div>
            </div>

            <button type="button" class="moa-btn moa-btn--ghost" data-action="back-to-phonemes">
              ← Volver a sonidos
            </button>
          </div>
        `;
      }

      function handleGridClick(e) {
        const btn = e.target.closest("button, a");
        if (!btn) return;

        const cardEl = btn.closest("[data-card-id]");
        if (!cardEl) return;

        const cardId = cardEl.getAttribute("data-card-id");
        const card = cardsData.find((c) => c.id === cardId);
        if (!card) return;

        const st = state.get(cardId);
        if (!st) return;

        const action = btn.getAttribute("data-action");

        if (action === "back") {
          if (st.mode === "phonemeVideo") return;
          setCardState(cardId, { step: clamp(st.step - 1, 1, TOTAL_STEPS), error: false });
          renderAll(cardsData);
          return;
        }

        if (action === "next") {
          if (st.mode === "phonemeVideo") return;
          setCardState(cardId, { step: clamp(st.step + 1, 1, TOTAL_STEPS), error: false });
          renderAll(cardsData);
          return;
        }

        if (action === "open-phoneme") {
          if (st.step !== TOTAL_STEPS) return;
          const label = btn.getAttribute("data-phoneme-label");
          if (!label) return;

          setCardState(cardId, { mode: "phonemeVideo", phonemeLabel: label, error: false });
          renderAll(cardsData);

          const updatedCard = grid.querySelector(`[data-card-id="${CSS.escape(cardId)}"]`);
          const video = updatedCard?.querySelector('[data-role="phoneme-video"]');
          if (video) video.focus?.();
          return;
        }

        if (action === "back-to-phonemes") {
          setCardState(cardId, { mode: "steps", phonemeLabel: null, error: false, step: TOTAL_STEPS });
          renderAll(cardsData);
          return;
        }
      }

      function handleVideoError(e) {
        const video = e.target.closest("video");
        if (!video) return;

        const cardEl = video.closest("[data-card-id]");
        if (!cardEl) return;

        const cardId = cardEl.getAttribute("data-card-id");
        const st = state.get(cardId);
        if (!st) return;

        setCardState(cardId, { error: true });
        renderAll(cardsData);
      }

      function shuffleInPlace(arr) {
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
      }

      function onShuffle() {
        shuffleInPlace(cardsData);
        initState(cardsData);
        renderAll(cardsData);
      }

      function onReset() {
        initState(cardsData);
        renderAll(cardsData);
      }

      grid.addEventListener("click", handleGridClick);
      grid.addEventListener("error", handleVideoError, true);

      btnShuffle?.addEventListener("click", onShuffle);
      btnReset?.addEventListener("click", onReset);

      initState(cardsData);
      renderAll(cardsData);
    })();
  </script>
</section>






          




          
    

          <!-- END EDITABLE -->
        </div>
      </section>

      <!-- GAMES -->
      <section class="card" aria-labelledby="games-title">
        <h3 id="games-title" class="section-title">Games</h3>

        <section class="game-embed" id="game-week2" aria-label="Game embed area (Week 2)">
          <!-- START EDITABLE: GAMES -->
          <!-- Paste a full game block here (HTML + optional <style> + optional <script>) -->









          <section id="consonants-game" aria-label="Juego: tabla de sonidos consonánticos">
  <style>
    /* =========================
       Scoped styles
       ========================= */
    #consonants-game {
      --bg: #0b0f17;
      --panel: #111a2a;
      --panel2: #0f1726;
      --text: #eaf0ff;
      --muted: #b7c5e6;
      --line: rgba(255,255,255,.12);
      --line2: rgba(255,255,255,.18);
      --good: #1faa59;
      --bad: #e55353;
      --warn: #ffbf47;
      --accent: #7aa7ff;

      color: var(--text);
      background: transparent;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }

    #consonants-game .cg-shell {
      max-width: 1180px;
      margin: 0 auto;
      padding: 16px;
    }

    #consonants-game .cg-header {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    #consonants-game .cg-title {
      margin: 0;
      font-size: 18px;
      line-height: 1.2;
      letter-spacing: .2px;
    }

    #consonants-game .cg-sub {
      margin: 6px 0 0;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      max-width: 70ch;
    }

    #consonants-game .cg-score {
      background: linear-gradient(180deg, rgba(122,167,255,.15), rgba(122,167,255,.06));
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      font-size: 14px;
      white-space: nowrap;
    }

    #consonants-game .cg-card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: 16px;
      overflow: hidden;
    }

    /* =========================
       TABLE (TOP)
       ========================= */
    #consonants-game .cg-tablewrap {
      margin-top: 8px;
      margin-bottom: 12px;
      padding: 10px;
    }

    #consonants-game table.cg-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      background: rgba(0,0,0,.10);
      border-radius: 12px;
      overflow: hidden;
    }

    #consonants-game .cg-table th,
    #consonants-game .cg-table td {
      border: 1px solid var(--line);
      padding: 8px 6px;
      text-align: center;
      font-size: 12px;
      line-height: 1.2;
      vertical-align: middle;
      word-wrap: break-word;
    }

    #consonants-game .cg-table thead th {
      background: rgba(122,167,255,.10);
      color: var(--text);
      font-weight: 650;
    }

    #consonants-game .cg-corner {
      background: rgba(255,255,255,.06) !important;
      font-weight: 700;
      text-align: left !important;
      padding-left: 10px !important;
    }

    #consonants-game .cg-corner small {
      display: block;
      margin-top: 2px;
      font-weight: 550;
      color: var(--muted);
    }

    #consonants-game .cg-super {
      text-align: center !important;
      font-size: 12px;
      letter-spacing: .25px;
    }

    #consonants-game .cg-rowhead {
      background: rgba(255,255,255,.05);
      text-align: left !important;
      padding-left: 10px !important;
      font-weight: 700;
      color: var(--text);
      width: 160px;
    }

    #consonants-game .cg-cell {
      min-height: 34px;
    }

    #consonants-game .cg-cell .cg-placed {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      font-weight: 750;
      font-size: 12px;
    }

    /* =========================
       CAROUSEL
       ========================= */
    #consonants-game .cg-topbar {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    #consonants-game .cg-tools {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    #consonants-game .cg-btn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 9px 10px;
      font-size: 13px;
      cursor: pointer;
    }
    #consonants-game .cg-btn:hover { border-color: rgba(255,255,255,.25); }
    #consonants-game .cg-btn:focus-visible {
      outline: 3px solid rgba(122,167,255,.45);
      outline-offset: 2px;
    }

    #consonants-game .cg-carousel {
      flex: 1 1 520px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 8px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(0,0,0,.10);
      scroll-snap-type: x mandatory;
    }

    #consonants-game .cg-chip {
      scroll-snap-align: start;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 10px;
      font-size: 13px;
      font-weight: 750;
      cursor: pointer;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      user-select: none;
    }

    #consonants-game .cg-chip[data-status="correct"] {
      background: rgba(31,170,89,.18);
      border-color: rgba(31,170,89,.45);
      color: #eafff2;
    }

    #consonants-game .cg-chip[data-status="wrong"] {
      background: rgba(229,83,83,.18);
      border-color: rgba(229,83,83,.45);
      color: #ffecec;
    }

    #consonants-game .cg-chip.is-active {
      box-shadow: 0 0 0 3px rgba(122,167,255,.35);
      border-color: rgba(122,167,255,.65);
    }

    #consonants-game .cg-chip:disabled {
      opacity: .8;
      cursor: not-allowed;
    }

    /* =========================
       BELOW CAROUSEL: left info + right hints
       ========================= */
    #consonants-game .cg-below {
      display: grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      align-items: start;
      margin-bottom: 12px;
    }

    /* Responsive: panel above, hints below */
    @media (max-width: 860px) {
      #consonants-game .cg-below {
        grid-template-columns: 1fr;
      }
    }

    #consonants-game .cg-info,
    #consonants-game .cg-hints {
      padding: 12px;
    }

    #consonants-game .cg-info h4 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: .2px;
    }

    #consonants-game .cg-selected {
      display: flex;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    #consonants-game .cg-symbol {
      font-size: 28px;
      font-weight: 900;
      letter-spacing: .6px;
    }

    #consonants-game .cg-audio {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    #consonants-game .cg-audio button {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.07);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      cursor: pointer;
    }

    #consonants-game .cg-audio button:hover { border-color: rgba(255,255,255,.25); }

    #consonants-game .cg-nav {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin: 10px 0 0;
    }

    #consonants-game .cg-examples {
      margin-top: 8px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
    }

    #consonants-game .cg-examples table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
    }
    #consonants-game .cg-examples th,
    #consonants-game .cg-examples td {
      border: 1px solid var(--line);
      padding: 6px 8px;
      font-size: 12.5px;
      text-align: left;
    }
    #consonants-game .cg-examples th {
      background: rgba(255,255,255,.05);
      color: var(--muted);
      font-weight: 700;
    }

    #consonants-game .cg-hints h4 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: .2px;
    }

    #consonants-game .cg-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }

    #consonants-game .cg-toggle input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent);
    }

    #consonants-game .cg-hintbox {
      border: 1px solid var(--line);
      background: rgba(0,0,0,.10);
      border-radius: 14px;
      padding: 10px;
      display: grid;
      gap: 10px;
    }

    #consonants-game .cg-hintbox img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }

    #consonants-game .cg-hintbox iframe {
      width: 100%;
      aspect-ratio: 16 / 9;
      border: 0;
      border-radius: 12px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
    }

    #consonants-game .cg-muted {
      color: var(--muted);
      font-size: 12.5px;
      line-height: 1.35;
    }

    /* =========================
       FORM (BOTTOM)
       ========================= */
    #consonants-game .cg-formwrap {
      padding: 12px;
    }

    #consonants-game .cg-formwrap h4 {
      margin: 0 0 8px;
      font-size: 14px;
      letter-spacing: .2px;
    }

    #consonants-game .cg-form {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items: end;
    }

    @media (max-width: 700px) {
      #consonants-game .cg-form {
        grid-template-columns: 1fr;
      }
    }

    #consonants-game label.cg-lab {
      display: grid;
      gap: 6px;
      font-size: 12.5px;
      color: var(--muted);
    }

    #consonants-game input.cg-inp {
      width: 100%;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      font-size: 14px;
    }

    #consonants-game input.cg-inp:focus-visible {
      outline: 3px solid rgba(122,167,255,.45);
      outline-offset: 2px;
    }

    #consonants-game .cg-voice {
      display: grid;
      gap: 6px;
    }

    #consonants-game .cg-voice .cg-voiceBtns {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    #consonants-game .cg-voiceBtn {
      border: 1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 999px;
      padding: 9px 12px;
      font-size: 13px;
      cursor: pointer;
    }

    #consonants-game .cg-voiceBtn[aria-pressed="true"] {
      border-color: rgba(122,167,255,.65);
      box-shadow: 0 0 0 3px rgba(122,167,255,.35);
      background: rgba(122,167,255,.12);
    }

    #consonants-game .cg-submit {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    #consonants-game .cg-feedback {
      margin-top: 10px;
      border-top: 1px solid var(--line);
      padding-top: 10px;
      min-height: 24px;
      font-size: 13px;
    }

    #consonants-game .cg-feedback.good { color: #dfffea; }
    #consonants-game .cg-feedback.good strong { color: var(--good); }

    #consonants-game .cg-feedback.bad { color: #ffecec; }
    #consonants-game .cg-feedback.bad strong { color: var(--bad); }

    #consonants-game .cg-feedback.warn { color: #fff6dc; }
    #consonants-game .cg-feedback.warn strong { color: var(--warn); }
  </style>

  <div class="cg-shell">
    <div class="cg-header">
      <div>
        <h3 class="cg-title">Juego: tabla de sonidos consonánticos</h3>
        <p class="cg-sub">
          Selecciona un <strong>sonido</strong> en la franja. Luego escribe su <strong>punto</strong> y <strong>modo</strong>, elige <strong>NS/S</strong>, y envía tu respuesta.
          Si aciertas, el sonido aparece en la celda correcta.
        </p>
      </div>
      <div class="cg-score" aria-live="polite">
        Aciertos: <strong data-role="score">0</strong>/<span data-role="total">0</span>
      </div>
    </div>

    <!-- TABLA ARRIBA -->
    <div class="cg-card cg-tablewrap" data-role="tablewrap" aria-label="Tabla IPA (punto/mode/sonoridad)"></div>

    <!-- CARRUSEL -->
    <div class="cg-topbar" aria-label="Franja de sonidos">
      <div class="cg-tools" role="group" aria-label="Controles">
        <button type="button" class="cg-btn" data-action="shuffle" aria-label="Mezclar sonidos">Mezclar</button>
        <button type="button" class="cg-btn" data-action="reset" aria-label="Reiniciar">Reiniciar</button>
      </div>
      <div class="cg-carousel" data-role="carousel" aria-label="Lista de sonidos (chips)"></div>
    </div>

    <!-- DEBAJO: IZQ info + DER pistas -->
    <div class="cg-below">
      <div class="cg-card cg-info" data-role="info" aria-label="Información del sonido"></div>
      <aside class="cg-card cg-hints" data-role="hints" aria-label="Pistas (derecha)"></aside>
    </div>

    <!-- FORMULARIO ABAJO -->
    <div class="cg-card cg-formwrap" aria-label="Respuestas">
      <h4>Ubica este sonido en la tabla</h4>
      <form class="cg-form" data-role="form" autocomplete="off">
        <label class="cg-lab">
          Punto de articulación
          <input class="cg-inp" type="text" inputmode="text" name="place" placeholder="bilabial, labiodental, dental..." aria-label="Punto de articulación" />
        </label>

        <label class="cg-lab">
          Modo de articulación
          <input class="cg-inp" type="text" inputmode="text" name="manner" placeholder="oclusivo, fricativo, vibrante simple..." aria-label="Modo de articulación" />
        </label>

        <div class="cg-voice" aria-label="Sonoridad">
          <div class="cg-muted">Sonoridad</div>
          <div class="cg-voiceBtns">
            <button type="button" class="cg-voiceBtn" data-voice="NS" aria-pressed="false" aria-label="No sonoro (NS)">NS (no sonoro)</button>
            <button type="button" class="cg-voiceBtn" data-voice="S" aria-pressed="false" aria-label="Sonoro (S)">S (sonoro)</button>
          </div>
        </div>

        <div class="cg-submit">
          <button type="submit" class="cg-btn" aria-label="Enviar respuesta">Enviar</button>
        </div>
      </form>

      <div class="cg-feedback" data-role="feedback" aria-live="polite"></div>
    </div>
  </div>

  <script>
    (function () {
      const root = document.getElementById("consonants-game");
      if (!root) return;

      // =========================
      // DATA (ground truth) — con tus correcciones:
      // 1) "vibrante múltible" -> "vibrante múltiple"
      // 2) video de Lateral = https://youtu.be/8Piih6Wang4
      // 3) usar "posalveolar" (sin guion) como valor canónico
      // 4) NO se cambian símbolos
      // =========================
      const phonemes = [
        // =========================
        // BILABIAL
        // =========================
        {
          label: "[p]",
          key: "p",
          place: "bilabial",
          manner: "oclusivo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/p-sound/examples/sound.mp4",
          examples: [
            { es: "papa", en: "potato" },
            { es: "pato", en: "duck" },
            { es: "sopa", en: "soup" }
          ],
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[b]",
          key: "b",
          place: "bilabial",
          manner: "oclusivo",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/b-sound/examples/sound.mp4",
          examples: [
            { es: "boca", en: "mouth" },
            { es: "barco", en: "boat/ship" },
            { es: "tambor", en: "drum" }
          ],
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[m]",
          key: "m",
          place: "bilabial",
          manner: "nasal",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/m-sound/examples/sound.mp4",
          examples: [
            { es: "mano", en: "hand" },
            { es: "cama", en: "bed" },
            { es: "mismo", en: "same" }
          ],
          placeImageUrl: "https://i.imgur.com/eTA4b4f.png",
          mannerYoutubeUrl: "https://youtu.be/QU4l_fwGDpU"
        },

        // =========================
        // LABIODENTAL
        // =========================
        {
          label: "[f]",
          key: "f",
          place: "labiodental",
          manner: "fricativo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/f-sound/examples/sound.mp4",
          examples: [
            { es: "foto", en: "photo" },
            { es: "familia", en: "family" },
            { es: "fuerte", en: "strong" }
          ],
          placeImageUrl: "https://i.imgur.com/R1ICFxW.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        },

        // =========================
        // DENTAL
        // =========================
        {
          label: "[t̪]",
          key: "t",
          place: "dental",
          manner: "oclusivo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/t-sound/examples/sound.mp4",
          examples: [
            { es: "taza", en: "cup" },
            { es: "tarde", en: "afternoon" },
            { es: "gato", en: "cat" }
          ],
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[d̪]",
          key: "d",
          place: "dental",
          manner: "oclusivo",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/d-sound/examples/sound.mp4",
          examples: [
            { es: "dedo", en: "finger" },
            { es: "donde", en: "where" },
            { es: "andar", en: "to walk" }
          ],
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[θ]",
          key: "θ",
          place: "dental",
          manner: "fricativo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/theta-sound/examples/sound.mp4",
          examples: [
            { es: "cena", en: "dinner" },
            { es: "zapato", en: "shoe" },
            { es: "cinco", en: "five" }
          ],
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        },
        {
          label: "[ð]",
          key: "ð",
          place: "dental",
          manner: "fricativo",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/eth-low-sound/examples/sound.mp4",
          examples: [
            { es: "cada", en: "each" },
            { es: "nada", en: "nothing" },
            { es: "lado", en: "side" }
          ],
          placeImageUrl: "https://i.imgur.com/fvXM6Kf.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        },

        // =========================
        // ALVEOLAR
        // =========================
        {
          label: "[s]",
          key: "s",
          place: "alveolar",
          manner: "fricativo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/s-sound/examples/sound.mp4",
          examples: [
            { es: "sapo", en: "toad" },
            { es: "casa", en: "house" },
            { es: "dos", en: "two" }
          ],
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        },
        {
          label: "[n]",
          key: "n",
          place: "alveolar",
          manner: "nasal",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-bridge-sound/examples/sound.mp4",
          examples: [
            { es: "nube", en: "cloud" },
            { es: "pan", en: "bread" },
            { es: "nada", en: "nothing" }
          ],
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          mannerYoutubeUrl: "https://youtu.be/QU4l_fwGDpU"
        },
        {
          label: "[ɾ]",
          key: "ɾ",
          place: "alveolar",
          manner: "vibrante simple",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-short-sound/examples/sound.mp4",
          examples: [
            { es: "pero", en: "but" },
            { es: "cara", en: "face" },
            { es: "arena", en: "sand" }
          ],
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          mannerYoutubeUrl: "https://youtu.be/8Piih6Wang4"
        },
        {
          label: "[r]",
          key: "r",
          place: "alveolar",
          manner: "vibrante múltiple",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/r-rolled-sound/examples/sound.mp4",
          examples: [
            { es: "perro", en: "dog" },
            { es: "carro", en: "car/cart" },
            { es: "rojo", en: "red" }
          ],
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          mannerYoutubeUrl: "https://youtu.be/8Piih6Wang4"
        },
        {
          label: "[l]",
          key: "l",
          place: "alveolar",
          manner: "lateral",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/l-hiarch-sound/examples/sound.mp4",
          examples: [
            { es: "luna", en: "moon" },
            { es: "pelo", en: "hair" },
            { es: "sal", en: "salt" }
          ],
          placeImageUrl: "https://i.imgur.com/0xUzUmC.png",
          mannerYoutubeUrl: "https://youtu.be/8Piih6Wang4"
        },

        // =========================
        // POSALVEOLAR
        // =========================
        {
          label: "[ʧ]",
          key: "ʧ",
          place: "posalveolar",
          manner: "africado",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/ch-sound/examples/sound.mp4",
          examples: [
            { es: "chico", en: "boy" },
            { es: "leche", en: "milk" },
            { es: "mucho", en: "a lot" }
          ],
          placeImageUrl: "https://i.imgur.com/vD0C2wx.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=iCkWykHg394"
        },

        // =========================
        // PALATAL
        // =========================
        {
          label: "[ɲ]",
          key: "ɲ",
          place: "palatal",
          manner: "nasal",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-left-sound/examples/sound.mp4",
          examples: [
            { es: "niño", en: "child" },
            { es: "mañana", en: "tomorrow" },
            { es: "señor", en: "sir" }
          ],
          placeImageUrl: "https://i.imgur.com/yAriL9U.png",
          mannerYoutubeUrl: "https://youtu.be/QU4l_fwGDpU"
        },
        {
          label: "[ʝ]",
          key: "ʝ",
          place: "palatal",
          manner: "fricativo",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/yot-sound/examples/sound.mp4",
          examples: [
            { es: "yo", en: "I" },
            { es: "ayer", en: "yesterday" },
            { es: "mayo", en: "May" }
          ],
          placeImageUrl: "https://i.imgur.com/yAriL9U.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        },

        // =========================
        // VELAR
        // =========================
        {
          label: "[k]",
          key: "k",
          place: "velar",
          manner: "oclusivo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/k-sound/examples/sound.mp4",
          examples: [
            { es: "casa", en: "house" },
            { es: "queso", en: "cheese" },
            { es: "kilo", en: "kilogram" }
          ],
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[g]",
          key: "g",
          place: "velar",
          manner: "oclusivo",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/g-sound/examples/sound.mp4",
          examples: [
            { es: "gato", en: "cat" },
            { es: "guerra", en: "war" },
            { es: "amigo", en: "friend" }
          ],
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=SiNnbm15ePg"
        },
        {
          label: "[ŋ]",
          key: "ŋ",
          place: "velar",
          manner: "nasal",
          voicing: "S",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/n-right1-sound/examples/sound.mp4",
          examples: [
            { es: "tengo", en: "I have" },
            { es: "banco", en: "bank" },
            { es: "cinco", en: "five" }
          ],
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          mannerYoutubeUrl: "https://youtu.be/QU4l_fwGDpU"
        },
        {
          label: "[x]",
          key: "x",
          place: "velar",
          manner: "fricativo",
          voicing: "NS",
          soundMp4: "https://soundsofspeech.uiowa.edu/assets/phonemes/es/chi-sound/examples/sound.mp4",
          examples: [
            { es: "jamón", en: "ham" },
            { es: "gente", en: "people" },
            { es: "ojo", en: "eye" }
          ],
          placeImageUrl: "https://i.imgur.com/5qqyMDZ.png",
          mannerYoutubeUrl: "https://www.youtube.com/watch?v=CaDPmrWbNbY"
        }
      ];

      // =========================
      // CONSTANTS (canonical)
      // =========================
      const PLACES = ["bilabial", "labiodental", "dental", "alveolar", "posalveolar", "palatal", "velar"];
      const PLACE_LABEL = {
        bilabial: "Bilabial",
        labiodental: "Labiodental",
        dental: "Dental",
        alveolar: "Alveolar",
        posalveolar: "Posalveolar",
        palatal: "Palatal",
        velar: "Velar"
      };

      const MANNERS = [
        "oclusivo",
        "nasal",
        "vibrante múltiple",
        "vibrante simple",
        "fricativo",
        "africado",
        "lateral"
      ];
      const MANNER_LABEL = {
        "oclusivo": "Oclusivo",
        "nasal": "Nasal",
        "vibrante múltiple": "Vibrante múltiple",
        "vibrante simple": "Vibrante simple",
        "fricativo": "Fricativo",
        "africado": "Africado",
        "lateral": "Lateral"
      };

      const VOICINGS = ["NS", "S"]; // NS primero, S después

      // =========================
      // ELEMENTS
      // =========================
      const elScore = root.querySelector('[data-role="score"]');
      const elTotal = root.querySelector('[data-role="total"]');
      const elTableWrap = root.querySelector('[data-role="tablewrap"]');
      const elCarousel = root.querySelector('[data-role="carousel"]');
      const elInfo = root.querySelector('[data-role="info"]');
      const elHints = root.querySelector('[data-role="hints"]');
      const elForm = root.querySelector('[data-role="form"]');
      const elFeedback = root.querySelector('[data-role="feedback"]');
      const btnShuffle = root.querySelector('[data-action="shuffle"]');
      const btnReset = root.querySelector('[data-action="reset"]');
      const inputPlace = elForm.querySelector('input[name="place"]');
      const inputManner = elForm.querySelector('input[name="manner"]');
      const voiceBtns = Array.from(root.querySelectorAll(".cg-voiceBtn"));

      // =========================
      // STATE
      // =========================
      const state = {
        order: [],
        selectedIndex: 0,
        selectedVoicing: null,
        chipStatus: new Map(), // key -> neutral|wrong|correct
        placed: new Set(),     // key
        score: 0,
        hintsOn: false,
        // Form values to prevent loss on clicks (bug fix)
        formPlace: "",
        formManner: ""
      };

      // =========================
      // HELPERS: shuffle
      // =========================
      function shuffleArray(arr) {
        const a = arr.slice();
        for (let i = a.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
      }

      // =========================
      // NORMALIZATION (tildes/mayus/guiones/espacios/puntos)
      // =========================
      function normalizeText(s) {
        return String(s || "")
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")   // remove diacritics
          .replace(/[.\u00B7]/g, "")        // remove dots / middle dot
          .replace(/[\s\-_/]+/g, "")        // remove spaces and hyphens/underscores
          .trim();
      }

      function canonicalPlace(raw) {
        const n = normalizeText(raw);
        if (!n) return "";

        // Accept: posalveolar, pos-alveolar, pos alveolar, postalveolar
        if (n === "posalveolar" || n === "posalveolar" || n === "postalveolar") return "posalveolar";

        // Common direct matches
        if (n === "bilabial") return "bilabial";
        if (n === "labiodental") return "labiodental";
        if (n === "dental") return "dental";
        if (n === "alveolar") return "alveolar";
        if (n === "palatal") return "palatal";
        if (n === "velar") return "velar";

        return "";
      }

      function canonicalManner(raw) {
        const n = normalizeText(raw);
        if (!n) return "";

        // Accept gender variants
        if (n === "oclusivo" || n === "oclusiva") return "oclusivo";
        if (n === "fricativo" || n === "fricativa") return "fricativo";
        if (n === "africado" || n === "africada") return "africado";
        if (n === "nasal") return "nasal";
        if (n === "lateral") return "lateral";

        // Vibrantes
        if (n === "vibrantesimple" || n === "vibsimp" || n === "vibsimp" || n === "vibsimp" || n === "vibsimple") return "vibrante simple";
        if (n === "vibrantemultiple" || n === "vibmult" || n === "vibmult" || n === "vibmultiple" || n === "vibrantemult") return "vibrante múltiple";
        // Por si alguien escribe "multible" (typo)
        if (n === "vibrantemultible") return "vibrante múltiple";

        return "";
      }

      function normalizeVoicing(raw) {
        const n = normalizeText(raw);
        if (!n) return "";
        if (n === "ns" || n === "nosonoro" || n === "nsonoro" || n === "sordo" || n === "sorda") return "NS";
        if (n === "s" || n === "sonoro" || n === "sonora") return "S";
        return "";
      }

      // =========================
      // YouTube embed URL (no external links/buttons)
      // =========================
      function youtubeToEmbed(url) {
        const u = String(url || "");
        if (!u) return "";
        try {
          // youtu.be/<id>
          let m = u.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
          if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];

          // youtube.com/watch?v=<id>
          m = u.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
          if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];

          // already embed
          m = u.match(/youtube\.com\/embed\/([A-Za-z0-9_-]{6,})/);
          if (m && m[1]) return "https://www.youtube.com/embed/" + m[1];
        } catch (e) {}
        return "";
      }

      // =========================
      // BUILD TABLE (header doble + esquina visual clara)
      // =========================
      const cellMap = new Map(); // key = manner|place|voicing -> td

      function buildTable() {
        const table = document.createElement("table");
        table.className = "cg-table";
        table.setAttribute("aria-label", "Tabla: punto (columnas), modo (filas) y sonoridad (NS/S)");

        const thead = document.createElement("thead");

        // Row 1: corner + super header
        const r1 = document.createElement("tr");

        const thCorner = document.createElement("th");
        thCorner.className = "cg-corner";
        thCorner.setAttribute("rowspan", "3");
        thCorner.setAttribute("scope", "col");
        thCorner.innerHTML = `MODO (filas) ↓<small>PUNTO (columnas) →</small>`;
        r1.appendChild(thCorner);

        const thSuper = document.createElement("th");
        thSuper.className = "cg-super";
        thSuper.setAttribute("colspan", String(PLACES.length * 2));
        thSuper.setAttribute("scope", "colgroup");
        thSuper.textContent = "PUNTO DE ARTICULACIÓN →";
        r1.appendChild(thSuper);

        thead.appendChild(r1);

        // Row 2: place headers (colspan 2)
        const r2 = document.createElement("tr");
        for (const p of PLACES) {
          const th = document.createElement("th");
          th.setAttribute("colspan", "2");
          th.setAttribute("scope", "colgroup");
          th.textContent = PLACE_LABEL[p];
          r2.appendChild(th);
        }
        thead.appendChild(r2);

        // Row 3: NS / S
        const r3 = document.createElement("tr");
        for (let i = 0; i < PLACES.length; i++) {
          const thNS = document.createElement("th");
          thNS.setAttribute("scope", "col");
          thNS.textContent = "NS";
          r3.appendChild(thNS);

          const thS = document.createElement("th");
          thS.setAttribute("scope", "col");
          thS.textContent = "S";
          r3.appendChild(thS);
        }
        thead.appendChild(r3);

        table.appendChild(thead);

        const tbody = document.createElement("tbody");

        for (const m of MANNERS) {
          const tr = document.createElement("tr");

          const rowHead = document.createElement("th");
          rowHead.className = "cg-rowhead";
          rowHead.setAttribute("scope", "row");
          rowHead.textContent = MANNER_LABEL[m] || m;
          tr.appendChild(rowHead);

          for (const p of PLACES) {
            for (const v of VOICINGS) {
              const td = document.createElement("td");
              td.className = "cg-cell";
              td.setAttribute("data-cell", `${m}|${p}|${v}`);
              tr.appendChild(td);
              cellMap.set(`${m}|${p}|${v}`, td);
            }
          }
          tbody.appendChild(tr);
        }

        table.appendChild(tbody);

        elTableWrap.innerHTML = "";
        elTableWrap.appendChild(table);
      }

      function setCell(manner, place, voicing, label) {
        const key = `${manner}|${place}|${voicing}`;
        const cell = cellMap.get(key);
        if (!cell) return;
        cell.innerHTML = `<span class="cg-placed">${label}</span>`;
      }

      function clearAllCells() {
        for (const td of cellMap.values()) {
          td.innerHTML = "";
        }
      }

      // =========================
      // BUILD CAROUSEL
      // =========================
      function renderCarousel() {
        elCarousel.innerHTML = "";
        state.order.forEach((pKey, idx) => {
          const p = phonemesByKey.get(pKey);
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "cg-chip";
          btn.setAttribute("data-key", p.key);
          btn.setAttribute("data-idx", String(idx));
          btn.setAttribute("data-status", state.chipStatus.get(p.key) || "neutral");
          btn.setAttribute("aria-label", `Sonido ${p.label}`);
          btn.innerHTML = `${p.label}`;

          if (idx === state.selectedIndex) btn.classList.add("is-active");

          // Optional: disable correct
          if (state.chipStatus.get(p.key) === "correct") {
            btn.disabled = true;
          }

          btn.addEventListener("click", () => {
            state.selectedIndex = idx;
            // reset selection-specific form + voicing + feedback
            state.selectedVoicing = null;
            setVoiceUI(null);

            // clear form fields when switching sonido
            state.formPlace = "";
            state.formManner = "";
            inputPlace.value = "";
            inputManner.value = "";

            setFeedback("", "");
            renderCarousel();
            renderInfoAndHints();
          });

          elCarousel.appendChild(btn);
        });
      }

      // =========================
      // INFO + HINTS
      // =========================
      let audioEl = null;

      function currentPhoneme() {
        const k = state.order[state.selectedIndex];
        return phonemesByKey.get(k);
      }

      function renderInfoAndHints() {
        const p = currentPhoneme();
        if (!p) return;

        // INFO (left)
        elInfo.innerHTML = "";
        const h = document.createElement("h4");
        h.textContent = "Sonido seleccionado";
        elInfo.appendChild(h);

        const top = document.createElement("div");
        top.className = "cg-selected";

        const sym = document.createElement("div");
        sym.className = "cg-symbol";
        sym.textContent = p.label;

        const audioWrap = document.createElement("div");
        audioWrap.className = "cg-audio";

        const playBtn = document.createElement("button");
        playBtn.type = "button";
        playBtn.textContent = "▶️ Escuchar";
        playBtn.setAttribute("aria-label", `Escuchar ${p.label}`);

        const stopBtn = document.createElement("button");
        stopBtn.type = "button";
        stopBtn.textContent = "⏹️ Parar";
        stopBtn.setAttribute("aria-label", `Parar audio ${p.label}`);

        if (!audioEl) {
          audioEl = document.createElement("audio");
          audioEl.preload = "none";
        }
        audioEl.src = p.soundMp4;

        playBtn.addEventListener("click", () => {
          try {
            audioEl.currentTime = 0;
            audioEl.play();
          } catch (e) {}
        });

        stopBtn.addEventListener("click", () => {
          try {
            audioEl.pause();
            audioEl.currentTime = 0;
          } catch (e) {}
        });

        audioWrap.appendChild(playBtn);
        audioWrap.appendChild(stopBtn);

        top.appendChild(sym);
        top.appendChild(audioWrap);
        elInfo.appendChild(top);

        // Examples
        const exWrap = document.createElement("div");
        exWrap.className = "cg-examples";

        const exTitle = document.createElement("div");
        exTitle.className = "cg-muted";
        exTitle.innerHTML = "<strong>Ejemplos</strong>";
        exWrap.appendChild(exTitle);

        const exTable = document.createElement("table");
        const trh = document.createElement("tr");
        const th1 = document.createElement("th"); th1.textContent = "Español";
        const th2 = document.createElement("th"); th2.textContent = "Inglés";
        trh.appendChild(th1); trh.appendChild(th2);
        const thead = document.createElement("thead");
        thead.appendChild(trh);
        exTable.appendChild(thead);

        const tbody = document.createElement("tbody");
        (p.examples || []).forEach(row => {
          const tr = document.createElement("tr");
          const td1 = document.createElement("td"); td1.textContent = row.es || "";
          const td2 = document.createElement("td"); td2.textContent = row.en || "";
          tr.appendChild(td1); tr.appendChild(td2);
          tbody.appendChild(tr);
        });
        exTable.appendChild(tbody);
        exWrap.appendChild(exTable);
        elInfo.appendChild(exWrap);

        // NAV
        const nav = document.createElement("div");
        nav.className = "cg-nav";

        const prevBtn = document.createElement("button");
        prevBtn.type = "button";
        prevBtn.className = "cg-btn";
        prevBtn.textContent = "Anterior";
        prevBtn.addEventListener("click", () => {
          state.selectedIndex = (state.selectedIndex - 1 + state.order.length) % state.order.length;
          state.selectedVoicing = null;
          setVoiceUI(null);
          state.formPlace = "";
          state.formManner = "";
          inputPlace.value = "";
          inputManner.value = "";
          setFeedback("", "");
          renderCarousel();
          renderInfoAndHints();
        });

        const nextBtn = document.createElement("button");
        nextBtn.type = "button";
        nextBtn.className = "cg-btn";
        nextBtn.textContent = "Siguiente";
        nextBtn.addEventListener("click", () => {
          state.selectedIndex = (state.selectedIndex + 1) % state.order.length;
          state.selectedVoicing = null;
          setVoiceUI(null);
          state.formPlace = "";
          state.formManner = "";
          inputPlace.value = "";
          inputManner.value = "";
          setFeedback("", "");
          renderCarousel();
          renderInfoAndHints();
        });

        nav.appendChild(prevBtn);
        nav.appendChild(nextBtn);
        elInfo.appendChild(nav);

        // HINTS (right)
        elHints.innerHTML = "";
        const hh = document.createElement("h4");
        hh.textContent = "Pistas";
        elHints.appendChild(hh);

        const toggleWrap = document.createElement("label");
        toggleWrap.className = "cg-toggle";
        toggleWrap.innerHTML = `<input type="checkbox" /> <span>Mostrar pistas</span>`;
        const checkbox = toggleWrap.querySelector("input");
        checkbox.checked = !!state.hintsOn;

        checkbox.addEventListener("change", () => {
          state.hintsOn = checkbox.checked;
          renderHintsBox();
        });

        elHints.appendChild(toggleWrap);

        const hintBox = document.createElement("div");
        hintBox.className = "cg-hintbox";
        hintBox.setAttribute("data-role", "hintbox");
        elHints.appendChild(hintBox);

        const hintNote = document.createElement("div");
        hintNote.className = "cg-muted";
        hintNote.textContent = "Incluye (1) imagen del punto y (2) video del modo.";
        elHints.appendChild(hintNote);

        function renderHintsBox() {
          hintBox.innerHTML = "";
          if (!state.hintsOn) {
            const msg = document.createElement("div");
            msg.className = "cg-muted";
            msg.textContent = "Las pistas están ocultas. Activa “Mostrar pistas” si las necesitas.";
            hintBox.appendChild(msg);
            return;
          }

          // Place image
          const img = document.createElement("img");
          img.src = p.placeImageUrl;
          img.alt = `Imagen del punto de articulación (${PLACE_LABEL[canonicalPlace(p.place)] || p.place})`;
          hintBox.appendChild(img);

          // Manner video
          const embed = youtubeToEmbed(p.mannerYoutubeUrl);
          if (embed) {
            const iframe = document.createElement("iframe");
            iframe.src = embed;
            iframe.loading = "lazy";
            iframe.title = `Video del modo de articulación (${p.manner})`;
            iframe.allow = "accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share";
            iframe.referrerPolicy = "strict-origin-when-cross-origin";
            iframe.allowFullscreen = true;
            hintBox.appendChild(iframe);
          } else {
            const msg = document.createElement("div");
            msg.className = "cg-muted";
            msg.textContent = "No se pudo generar el embed del video (URL no reconocida).";
            hintBox.appendChild(msg);
          }
        }

        renderHintsBox();
      }

      // =========================
      // FEEDBACK
      // =========================
      function setFeedback(kind, html) {
        elFeedback.className = "cg-feedback";
        if (kind) elFeedback.classList.add(kind);
        elFeedback.innerHTML = html || "";
      }

      // =========================
      // VOICING UI (bug fix: no re-render of inputs)
      // =========================
      function setVoiceUI(value) {
        voiceBtns.forEach(btn => {
          const v = btn.getAttribute("data-voice");
          const pressed = v === value;
          btn.setAttribute("aria-pressed", pressed ? "true" : "false");
        });
      }

      voiceBtns.forEach(btn => {
        btn.addEventListener("click", () => {
          // Preserve typed input values (bug fix)
          state.formPlace = inputPlace.value;
          state.formManner = inputManner.value;

          const v = btn.getAttribute("data-voice");
          state.selectedVoicing = (state.selectedVoicing === v) ? null : v;

          setVoiceUI(state.selectedVoicing);

          // Restore typed values (in case something else touches DOM)
          inputPlace.value = state.formPlace;
          inputManner.value = state.formManner;
        });
      });

      // Track typing persistently (so nothing se pierde)
      inputPlace.addEventListener("input", () => { state.formPlace = inputPlace.value; });
      inputManner.addEventListener("input", () => { state.formManner = inputManner.value; });

      // =========================
      // CHECK ANSWER
      // =========================
      function compareAnswer(p, userPlace, userManner, userVoicing) {
        const placeTruth = canonicalPlace(p.place);
        const mannerTruth = canonicalManner(p.manner);
        const voiceTruth = p.voicing;

        return (
          canonicalPlace(userPlace) === placeTruth &&
          canonicalManner(userManner) === mannerTruth &&
          normalizeVoicing(userVoicing) === voiceTruth
        );
      }

      // =========================
      // INIT
      // =========================
      const phonemesByKey = new Map();
      phonemes.forEach(p => phonemesByKey.set(p.key, p));

      elTotal.textContent = String(phonemes.length);

      function hardReset() {
        state.order = shuffleArray(phonemes.map(p => p.key));
        state.selectedIndex = 0;
        state.selectedVoicing = null;
        state.hintsOn = false;
        state.score = 0;
        state.chipStatus = new Map();
        state.placed = new Set();
        state.formPlace = "";
        state.formManner = "";
        inputPlace.value = "";
        inputManner.value = "";
        setVoiceUI(null);
        setFeedback("", "");
        elScore.textContent = "0";
        clearAllCells();
        renderCarousel();
        renderInfoAndHints();
      }

      btnShuffle.addEventListener("click", () => {
        // shuffle sin borrar progreso: mantener status, placed, score
        const currentKey = state.order[state.selectedIndex];
        state.order = shuffleArray(state.order);
        state.selectedIndex = Math.max(0, state.order.indexOf(currentKey));
        renderCarousel();
      });

      btnReset.addEventListener("click", () => {
        hardReset();
      });

      elForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const p = currentPhoneme();
        if (!p) return;

        // Preserve typed
        state.formPlace = inputPlace.value;
        state.formManner = inputManner.value;

        const userPlace = inputPlace.value;
        const userManner = inputManner.value;
        const userVoicing = state.selectedVoicing;

        if (!userPlace.trim() || !userManner.trim() || !userVoicing) {
          setFeedback("warn", `<strong>Falta algo.</strong> Escribe punto y modo, y elige NS o S.`);
          return;
        }

        const ok = compareAnswer(p, userPlace, userManner, userVoicing);

        if (ok) {
          if (!state.placed.has(p.key)) {
            state.placed.add(p.key);
            state.score += 1;
            elScore.textContent = String(state.score);
          }

          // Place in table
          const mannerKey = canonicalManner(p.manner);
          const placeKey = canonicalPlace(p.place);
          const voiceKey = p.voicing;
          setCell(mannerKey, placeKey, voiceKey, p.label);

          state.chipStatus.set(p.key, "correct");

          setFeedback("good", `<strong>Correcto.</strong> ¡Bien! El sonido se colocó en la tabla.`);

          // optional: auto-advance to next non-correct
          renderCarousel();
        } else {
          state.chipStatus.set(p.key, "wrong");
          setFeedback("bad", `<strong>Incorrecto.</strong> Intenta de nuevo.`);
          renderCarousel();
        }
      });

      // Build and start
      buildTable();
      hardReset();
    })();
  </script>
</section>












          
          <!-- END EDITABLE -->
        </section>
      </section>

      <nav class="page-nav page-nav--bottom" aria-label="Week navigation (bottom)">
        <a class="nav-link" href="../index.html">← Back to weeks</a>

        <div class="nav-group" aria-label="Previous and next week (bottom)">
          <a class="nav-link" href="./week1.html">← Prev</a>
          <a class="nav-link" href="./week3.html">Next →</a>
        </div>
      </nav>
    </main>

    <footer class="footer" role="contentinfo">
      <p>
        Sitio construido por Andrés Correal. Esta página se construyó con la ayuda de los materiales de
        Grant Armstrong, Martiniano Etchart y Kiley Specht.
      </p>
    </footer>

    <!-- Optional (future): add week-specific JS here. Create /week.js (empty is fine) to avoid 404. -->
    <script src="../week.js?v=3" defer></script>
  </body>
</html>

